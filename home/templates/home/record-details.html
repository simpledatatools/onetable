<div class="row mb-5">
  <div class="col-xl-12">
    <!-- Account details card-->
    <div class="card card-header-actions">
      <div class="card-header bg-white">
        <div id="record-title-{{record.id}}">{{ record.primary_field.value }}</div>
        <div class="dropdown no-caret">
          <button class="btn btn-transparent-dark btn-icon dropdown-toggle" id="dropdownMenuButton" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-bars"></i></button>
          <div class="dropdown-menu dropdown-menu-right animated--fade-in-up" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="{% url 'edit_record' organization_pk=organization.pk app_pk=app.pk list_pk=list.pk record_pk=record.pk %}">
              <div class="dropdown-item-icon"><i class="text-gray-500" data-feather="list"></i></div>
              Edit Record
            </a>
            <button data-toggle="modal" data-target="#archive_record_detail_{{record.id}}" class="dropdown-item" href="{% url 'archive_record' organization_pk=organization.pk app_pk=app.pk list_pk=list.pk record_pk=record.pk %}">
              <div class="dropdown-item-icon"><i class="text-gray-500" data-feather="list"></i></div>
              Archive Record
            </button>
          </div>
        </div>
      </div>
      <div class="modal fade" id="archive_record_detail_{{record.id}}" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalCenterTitle">Are you sure that you want to Archive {{record.list}}?</h5>
              <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-footer"><span class="btn btn-primary archive-record" data-record-detail-id="{{record.pk}}" type="button" data-dismiss="modal" href="{% url 'archive_record' organization_pk=organization.pk app_pk=app.pk list_pk=list.pk record_pk=record.pk %}" data-content-id="{{file.id}}">Archive</span><span class="btn btn-light" type="button" data-dismiss="modal">No</span></div>
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if record.record_fields %}
        {% for field in record.record_fields %}
        {% if field.list_field.primary is False %}
        {% if field.list_field.field_type == "choose-from-list" %}
        <p><b>{{ field.list_field.field_label }}:</b>
          {% if field.selected_record.status == 'active' %}
          <a href="{% url 'record' organization_pk=organization.pk app_pk=app.pk list_pk=list.pk record_pk=field.selected_record.pk %}">
          <span class="badge badge-primary p-2">{{ field.selected_record.primary_field.value }}
          </span>
          </a>
          {% endif %}
        </p>
        {% elif field.list_field.field_type == "url" %}
        <p><b>{{ field.list_field.field_label }}:</b> <a href="{{ field.value }}" target="_blank">{{ field.value }}</a></p>
        {% else %}
        <p><b>{{ field.list_field.field_label }}:</b> {{ field.value }}</p>
        {% endif %}
        {% endif %}
        {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
<div class="p-5 container">
  <div class="mb-3 row no-gutters" >
    <div class="col-6">
      <h5>Files and Uploads</h5>
    </div>
    <div class="col-6">
      <div id="postRecordFile" class="btn btn-primary float-right" action="{% url 'post_record_file' organization.pk app.pk list.pk record.pk %}">
        Add File
      </div>
    </div>
  </div>
  <hr>
  <div id="fileslist" class="row">
    <div id="template-preview" class="d-none"></div>
    {% for file in files %}
    <div id="file-{{file.pk}}" class="col-6">
      <div class="text-center m-3 card">
        <div class="card-body">
          <p class="card-text text-left">{{file.filename}}</p>
        </div>
        <div class="card-footer bg-white"><button class="btn btn-link float-right" type="button" data-toggle="modal" data-target="#remove-file-{{file.id}}" >Remove</button><a class="btn btn-link float-right" href="{{file.url}}">Download</a></div>
      </div>
    </div>
    <div class="modal fade" id="remove-file-{{file.id}}" tabindex="-1" role="dialog" aria-labelledby="Remove-comment" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalCenterTitle">Are you sure that you want to remove {{file.filename}}?</h5>
            <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
          </div>
          <div class="modal-footer"><span class="btn btn-danger remove-record-file" type="button" data-dismiss="modal" href="{{file.delete_url}}" data-content-id="{{file.id}}">Confirm</span><span class="btn btn-light" type="button" data-dismiss="modal">No</span></div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<div class="p-5 container">
  <div class="mb-3 row no-gutters" >
    <div class="col-6">
      <h5>Images and Videos</h5>
    </div>
    <div class="col-6">
      <div id="postRecordMedia" class="btn btn-primary float-right" action="{% url 'post_record_media' organization.pk app.pk list.pk record.pk %}">
        Add File
      </div>
    </div>
  </div>
  <hr>
  <div id="medialist" class="row">
    <div id="template-preview" class="d-none"></div>
    {% for file in media %}
    <div id="media-{{file.pk}}" class="col-3 h-100">
      <div class="text-center m-3 card">
        <div class="card-body">
          <p class="card-text text-left">
          <center><img src="{{file.url}}" class="img-fluid"/></center>
          </p>
        </div>
        <div class="card-footer bg-white"><button class="btn btn-link float-right" type="button" data-toggle="modal" data-target="#remove-media-{{file.pk}}">Remove</button><a class="btn btn-link float-right" href="{{file.url}}">Download</a></div>
      </div>
    </div>
    <div class="modal fade" id="remove-media-{{file.pk}}" tabindex="-1" role="dialog" aria-labelledby="Remove-comment" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalCenterTitle">Are you sure that you want to remove this?</h5>
            <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
          </div>
          <center>
            <div class="modal-body"><img src="{{file.url}}" class="img-fluid"/></div>
          </center>
          <div class="modal-footer"><span class="btn btn-danger remove-record-media" type="button" data-dismiss="modal" href="{{file.delete_url}}" data-content-id="{{file.id}}">Confirm</span><span class="btn btn-light" type="button" data-dismiss="modal">No</span></div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<div class="p-5 container">
  <h5>Comments</h5>
  <hr/>
  <form id="post_record_comment"  method="POST" action="{% url 'post_record_comments' organization.pk app.pk list.pk record.pk %}">
    {% csrf_token %}
    <input id="content" class="form-control bg-light mb-3" name="content" type="text" placeholder="Enter a comment here"/>
    <div class="text-right"><input class="btn btn-primary" id="post_record_button" type="submit"/></div>
  </form>
  <div class="d-block" id="record_comments">
    {% for comment in comments %}
    <div class='card m-3' id="comment-{{comment.pk}}" class="card text-center m-3">
      <div class="card-body">
        <p class="card-text text-left content">{{comment.content}}</p>
      </div>
      <div class="card-footer bg-white"><button class="btn btn-link float-right" type="button" data-toggle="modal" data-target="#remove-comment-{{comment.pk}}">Remove</button><a data-comment-id="{{comment.pk}}" href="{{comment.edit_url}}"  class="btn btn-link float-right edit-comment" >Edit</a></div>
    </div>
    <div class="modal fade" id="remove-comment-{{comment.pk}}" tabindex="-1" role="dialog" aria-labelledby="Remove-comment" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalCenterTitle">Are you sure that you want to remove the comment?</h5>
            <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
          </div>
          <div class="modal-body">{{comment.content}}</div>
          <div class="modal-footer"><span class="btn btn-danger remove-record-comment" type="button" data-dismiss="modal" href="{{comment.delete_url}}" data-content-id="{{comment.id}}">Confirm</span><span class="btn btn-light" type="button" data-dismiss="modal">No</span></div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<script>
var record_files = $('#fileslist');
var record_media = $('#medialist');

function getCookie(c_name) {
    var c_value = " " + document.cookie;
    var c_start = c_value.indexOf(" " + c_name + "=");
    if (c_start == -1) {
        c_value = null;
    } else {
        c_start = c_value.indexOf("=", c_start) + 1;
        var c_end = c_value.indexOf(";", c_start);
        if (c_end == -1) {
            c_end = c_value.length;
        }
        c_value = unescape(c_value.substring(c_start, c_end));
    }
    return c_value;
}

Dropzone.autoDiscover = false;

var cookie = document.cookie;
var csrftoken = getCookie('csrftoken');
var post_file_url = $('#postRecordFile').attr('action');
var post_media_url = $('#postRecordMedia').attr('action');
$(function() {
    var myDrop = new Dropzone("div#postRecordFile", {
        url: post_file_url,
        method: "post",
        headers: {
            "csrfmiddlewaretoken": csrftoken
        },
        previewsContainer: null,
        previewTemplate: document.getElementById('fileslist').innerHTML
    });

    myDrop.on("success", function(file, data) {
        data = JSON.parse(data);
        console.log(data);
        var file_div = ' <div id="file-' + data.id + '" class="col-6"> <div class="text-center m-3 card"> <div class="card-body"> <p class="card-text text-left">' + data.file_name + '</p> </div> <div class="card-footer bg-white"><button class="btn btn-link float-right" type="button" data-toggle="modal" data-target="#remove-file-' + data.id + '" >Remove</button><a class="btn btn-link float-right" href="' + data.file_url + '">Download</a></div> </div> </div> <div class="modal fade" id="remove-file-' + data.id + '" tabindex="-1" role="dialog" aria-labelledby="Remove-comment" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="exampleModalCenterTitle">Are you sure that you want to remove ' + data.file_name + '?</h5> <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button> </div> <div class="modal-footer"><span class="btn btn-danger remove-record-file" type="button" data-dismiss="modal" href="' + data.file_url + '" data-content-id="' + data.id + '">Confirm</span><span class="btn btn-light" type="button" data-dismiss="modal">No</span></div> </div> </div> </div>';
        record_files.prepend(file_div);
        RemoveContent('.remove-record-file', 'file');
    });
});


function RemoveContent(className, content) {
    $(className).on('click', function(ev) {
        ev.preventDefault();
        var url = $(this).attr('href');
        var content_id = $(this).attr('data-content-id');
        $.get(url, function(data) {
            console.log(content);
            console.log('#' + content + '-' + content_id);
            var content_box = $('#' + content + '-' + content_id);
            console.log(content_box);
            content_box.remove();
        });
    });
}

$(function() {
    var myDrop = new Dropzone("div#postRecordMedia", {
        url: post_media_url,
        method: "post",
        headers: {
            "csrfmiddlewaretoken": csrftoken
        },
        previewsContainer: null,
        previewTemplate: document.getElementById('medialist').innerHTML
    });

    myDrop.on("success", function(file, data) {
        data = JSON.parse(data);
        console.log(data);
        var media_div = ' <div id="media-' + data.id + '" class="col-3 h-100"> <div class="text-center m-3 card"> <div class="card-body"> <p class="card-text text-left"> <img src="' + data.file_url + '" class="img-fluid"/> </p> </div> <div class="card-footer bg-white"><button class="btn btn-link float-right" type="button" data-toggle="modal" data-target="#remove-media-' + data.id + '">Remove</button><a class="btn btn-link float-right" href="' + data.url + '">Download</a></div> </div> </div> <div class="modal fade" id="remove-media-' + data.id + '" tabindex="-1" role="dialog" aria-labelledby="Remove-comment" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="exampleModalCenterTitle">Are you sure that you want to remove this?</h5> <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button> </div> <div class="modal-body"><center><img src="' + data.file_url + '" class="img-fluid"/></center></div> <div class="modal-footer"><span class="btn btn-danger remove-record-media" type="button" data-dismiss="modal" href="' + data.file_url + '" data-content-id="' + data.id + '">Confirm</span><span class="btn btn-light" type="button" data-dismiss="modal">No</span></div> </div> </div></div>';
        record_media.prepend(media_div);
        RemoveContent('.remove-record-media', 'media');
    });
});


$(document).ready(function() {

    $(function() {
        var frm = $('#post_record_comment');
        frm.value = '';
        var record_comments = $('#record_comments');

        frm.submit(function(ev) {
            ev.preventDefault();
            console.log(frm.serialize('content'));

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }


            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            })



            $.ajax({

                type: frm.attr('method'),
                url: frm.attr('action'),
                data: frm.serialize(),
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function(data) {
                    var content = $('#content').val();
                    $('#content').val('');
                    console.log(data);
                    data = JSON.parse(data);
                    var comment_div = '<div class="card m-3" id="comment-' + data.id + '" class="card text-center m-3"><div class="card-body"><p class="card-text text-left content">' + data.content + '</p></div><div class="card-footer bg-white"><button class="btn btn-link float-right" type="button" data-toggle="modal" data-target="#remove-comment-' + data.id + '">Remove</button><a  href="' + data.edit_url + '"  class="btn btn-link float-right edit-comment" >Edit</a></div></div><div class="modal fade" id="remove-comment-' + data.id + '" tabindex="-1" role="dialog" aria-labelledby="Remove-comment" aria-hidden="true"><div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="exampleModalCenterTitle">Are you sure that you want to remove the comment?</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="modal-body">' + data.content + '</div><div class="modal-footer"><span class="btn btn-danger remove-record-comment" type="button" data-dismiss="modal" href="' + data.delete_url + '" data-content-id="' + data.id + '">Confirm</span><span class="btn btn-light" type="button" data-dismiss="modal">No</span></div></div></div></div>';
                    record_comments.prepend(comment_div);
                    EditPost();
                    RemoveContent('.remove-record-comment', 'comment');
                }
            });
            ev.preventDefault();
        });
    });

    function EditPost() {
        var edit_mode = false;
        var current_edit = null;
        $('.edit-comment').on('click', function(ev) {
                ev.preventDefault();
                var comment_id = $(this).attr('data-comment-id');

                var content = $('#comment-' + comment_id + ' .content');
                var content_message = content.html()
                if (edit_mode == false) {
                    if (current_edit == null) {
                        $(this).html('Save');
                        content.html('<textarea id="comment-content-' + comment_id + '" class="bg-light text-dark form-control w-100">' + content_message + '</textarea>');
                        edit_mode = true;
                        current_edit = $(this).attr('data-comment-id');
                    }
                } else {
                    this_comment = $(this).attr('data-comment-id');
                    console.log(this_comment);
                    console.log(current_edit);
                    if (this_comment == current_edit) {
                        edit_url = $(this).attr('href');
                        var new_comment = $('#comment-content-' + comment_id).val();
                        content.html(new_comment);
                        edit_mode = false;
                        current_edit = null;
                        $(this).html('Edit');
                        $.post(edit_url, {
                            "content": new_comment
                        }, function(data) {
                            console.log(data)
                        });
                    }
                }

            }

        );
    }

    EditPost();



    function ArchiveRecord() {
        $('.archive-record').on('click', function(ev) {
            ev.preventDefault();
            var archive_url = $(this).attr('href');
            var record_id = $(this).attr('data-record-detail-id');
            $.get(archive_url, function(data) {
                console.log(data);
                var record = $('#record-title-' + record_id);
                record.append('<span class="text-muted"> (Archived) </span>')
            });
        });
    }
    ArchiveRecord();

    RemoveContent('.remove-record-file', 'file');
    RemoveContent('.remove-record-media', 'media');
    RemoveContent('.remove-record-comment', 'comment');

});


</script>